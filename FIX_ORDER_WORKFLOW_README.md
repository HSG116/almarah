# ุฅุตูุงุญ ุณูุฑ ุนูู ุงูุทูุจุงุช - Order Workflow Fix

## ุงููุดุงูู ุงูุชู ุชู ุญููุง โ

### 1. ุฅุฑุณุงู ุงูุทูุจุงุช ููุฌุฒุงุฑูู
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏุ ูุง ูุชู ุฅุฑุณุงูู ููุฌุฒุงุฑูู ุชููุงุฆูุงู
- ุงูุฌุฒุงุฑ ูุง ูุนูู ุจูุฌูุฏ ุทูุจุงุช ุฌุฏูุฏุฉ

**ุงูุญู:**
- ุนูุฏ ุฅูุดุงุก ุฃู ุทูุจ ุฌุฏูุฏุ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ **ูุฌููุน ุงูุฌุฒุงุฑูู ุงูููุฌูุฏูู**
- ุงูุฅุดุนุงุฑ ูุญุชูู ุนูู:
  - ุงุณู ุงูุนููู
  - ุฅุฌูุงูู ุงูุทูุจ
  - ุฑูู ุงูุทูุจ

### 2. ุชุญููู ุงูุทูุจุงุช ููุชูุตูู
**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- ุนูุฏ ุฅููุงู ุงูุฌุฒุงุฑ ููุทูุจุ ูุง ูุชู ุชุญูููู ููุชูุตูู ุชููุงุฆูุงู
- ุงูุณุงุฆููู ูุง ูุนูููู ุจุงูุทูุจุงุช ุงูุฌุงูุฒุฉ

**ุงูุญู:**
- ุนูุฏ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ ุฅูู `ready` (ุฌุงูุฒ)ุ ูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ **ูุฌููุน ุณุงุฆูู ุงูุชูุตูู**
- ุงูุฅุดุนุงุฑ ูุญุชูู ุนูู:
  - ุฑูู ุงูุทูุจ
  - ุงุณู ุงูุนููู
  - ุฅุดุงุฑุฉ ุจุฃู ุงูุทูุจ ุฌุงูุฒ ููุชูุตูู

## ุงูุชุบููุฑุงุช ุงูุชูููุฉ ๐ง

### 1. Trigger ููุทูุจุงุช ุงูุฌุฏูุฏุฉ
```sql
CREATE TRIGGER trg_notify_butchers_new_order
    AFTER INSERT ON orders
```
- ูุชู ุชุดุบููู ุชููุงุฆูุงู ุนูุฏ ุฅุถุงูุฉ ุทูุจ ุฌุฏูุฏ
- ูุฑุณู ุฅุดุนุงุฑุงุช ูุฌููุน ุงูุฌุฒุงุฑูู (`role = 'butcher'`)

### 2. Trigger ููุทูุจุงุช ุงูุฌุงูุฒุฉ
```sql
CREATE TRIGGER trg_auto_forward_to_delivery
    AFTER UPDATE ON orders
```
- ูุชู ุชุดุบููู ุนูุฏ ุชุญุฏูุซ ุญุงูุฉ ุงูุทูุจ
- ุนูุฏูุง ุชุตุจุญ ุงูุญุงูุฉ `ready`ุ ูุฑุณู ุฅุดุนุงุฑุงุช ูุฌููุน ุงูุณุงุฆููู (`role = 'delivery'`)

### 3. ุฃุนูุฏุฉ ุฌุฏูุฏุฉ ููุชุชุจุน
ุชู ุฅุถุงูุฉ ุฃุนูุฏุฉ ุฌุฏูุฏุฉ ูุชุชุจุน ุงูุฃููุงุช:
- `processing_started_at` - ููุช ุจุฏุก ูุนุงูุฌุฉ ุงูุทูุจ
- `ready_at` - ููุช ุฌุงูุฒูุฉ ุงูุทูุจ ููุชูุตูู

### 4. ุชุญุณููุงุช ุนูู ุฌุฏูู ุงูุฅุดุนุงุฑุงุช
- ุฅุถุงูุฉ `user_id` ูุฑุจุท ุงูุฅุดุนุงุฑ ุจูุณุชุฎุฏู ูุนูู
- ุฅุถุงูุฉ `type` ูุชุตููู ุงูุฅุดุนุงุฑุงุช (order, delivery, general)
- ุฅูุดุงุก indexes ูุชุญุณูู ุงูุฃุฏุงุก

## ููููุฉ ุงูุชูููุฐ ๐

### ุฎุทูุฉ 1: ุชูููุฐ SQL Script
ูู ุจุชูููุฐ ุงูููู `FIX_ORDER_WORKFLOW.sql` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช Supabase:
1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู SQL Editor
3. ุงูุณุฎ ูุญุชูู ุงูููู `FIX_ORDER_WORKFLOW.sql`
4. ูููุฐ ุงูููุฏ

### ุฎุทูุฉ 2: ุงูุชุญูู ูู ุงูุชูููุฐ
ุจุนุฏ ุชูููุฐ ุงูุณูุฑูุจุชุ ููููู ุงูุชุญูู ูู:

```sql
-- ุงูุชุญูู ูู ูุฌูุฏ ุงูู Triggers
SELECT tgname, tgenabled 
FROM pg_trigger 
WHERE tgname LIKE '%butcher%' OR tgname LIKE '%delivery%';

-- ุงูุชุญูู ูู ูุฌูุฏ ุงูู Functions
SELECT proname 
FROM pg_proc 
WHERE proname LIKE '%butcher%' OR proname LIKE '%delivery%';
```

## ุณูุฑ ุงูุนูู ุงูุฌุฏูุฏ ๐

### 1. ุนูุฏ ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ:
```
ุนููู ูุทูุจ ุทูุจ
    โ
ุงูุญุงูุฉ: pending
    โ
ุฅุดุนุงุฑ ููุฑุณู ูุฌููุน ุงูุฌุฒุงุฑูู ๐
    โ
ุฌุฒุงุฑ ูุณุชูู ุงูุทูุจ ููุญููู ุงูุญุงูุฉ ุฅูู: processing
```

### 2. ุนูุฏ ุฅููุงู ุงูุฌุฒุงุฑ ููุทูุจ:
```
ุฌุฒุงุฑ ูููู ูุนุงูุฌุฉ ุงูุทูุจ
    โ
ุงูุญุงูุฉ: ready
    โ
ุฅุดุนุงุฑ ููุฑุณู ูุฌููุน ุงูุณุงุฆููู ๐
    โ
ุณุงุฆู ูุณุชูู ุงูุทูุจ ููุญููู ุงูุญุงูุฉ ุฅูู: shipping
```

### 3. ุนูุฏ ุชูุตูู ุงูุทูุจ:
```
ุณุงุฆู ููุตู ุงูุทูุจ
    โ
ุงูุญุงูุฉ: completed
    โ
ูุชู ุชุญุฏูุซ ูุญูุธุฉ ุงูุณุงุฆู ุชููุงุฆูุงู ๐ฐ
```

## ุงูุญุงูุงุช ุงููุฎุชููุฉ ููุทูุจ ๐

| ุงูุญุงูุฉ | ุงููุตู | ูู ูุณุชูู ุงูุฅุดุนุงุฑ |
|--------|-------|------------------|
| `pending` | ุทูุจ ุฌุฏูุฏ | ุฌููุน ุงูุฌุฒุงุฑูู |
| `processing` | ููุฏ ุงููุนุงูุฌุฉ ูู ูุจู ุฌุฒุงุฑ | - |
| `ready` | ุฌุงูุฒ ููุชูุตูู | ุฌููุน ุงูุณุงุฆููู |
| `shipping` | ููุฏ ุงูุชูุตูู | - |
| `arrived` | ูุตู ูุนููุงู ุงูุนููู | - |
| `completed` | ุชู ุงูุชุณููู | - |

## ููุงุญุธุงุช ูููุฉ โ๏ธ

1. **ุงูุฅุดุนุงุฑุงุช ุชูุฑุณู ููุฌููุน**: ูุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ูุฌููุน ุงูููุธููู ุงููุชุงุญูู (ุบูุฑ ุงููุญุธูุฑูู)
2. **ุงูุชูููุชุงุช ุงูุขููุฉ**: ูุชู ุชุณุฌูู ุฃููุงุช ุงููุนุงูุฌุฉ ูุงูุฌุงูุฒูุฉ ุชููุงุฆูุงู
3. **ุงูุฃุฏุงุก**: ุชู ุฅุถุงูุฉ indexes ูุถูุงู ุณุฑุนุฉ ุงูุงุณุชุนูุงูุงุช
4. **ุงููุญูุธุฉ**: ูุชู ุชุญุฏูุซ ูุญูุธุฉ ุงูุณุงุฆู ุชููุงุฆูุงู ุนูุฏ ุฅููุงู ุงูุชูุตูู (ูู DELIVERY_SYSTEM_SETUP.sql)

## ุงุฎุชุจุงุฑ ุงููุธุงู ๐งช

### ุงุฎุชุจุงุฑ 1: ุฅูุดุงุก ุทูุจ ุฌุฏูุฏ
1. ูู ุจุฅูุดุงุก ุทูุจ ุฌุฏูุฏ ูู ุฃู ุญุณุงุจ ุนููู
2. ุชุญูู ูู ุฌุฏูู `notifications` ูุณุชุฌุฏ ุฅุดุนุงุฑุงุช ูุฌููุน ุงูุฌุฒุงุฑูู
```sql
SELECT * FROM notifications WHERE type = 'order' ORDER BY created_at DESC LIMIT 10;
```

### ุงุฎุชุจุงุฑ 2: ุชุญููู ููุชูุตูู
1. ูู ุจุชุบููุฑ ุญุงูุฉ ุทูุจ ุฅูู `ready`
2. ุชุญูู ูู ุฌุฏูู `notifications` ูุณุชุฌุฏ ุฅุดุนุงุฑุงุช ูุฌููุน ุงูุณุงุฆููู
```sql
SELECT * FROM notifications WHERE type = 'delivery' ORDER BY created_at DESC LIMIT 10;
```

## ุงูุฏุนู ูุงููุณุงุนุฏุฉ ๐

ูู ุญุงู ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ุงูู logs ูู Supabase
2. ุชุฃูุฏ ูู ูุฌูุฏ ููุธููู ุจุตูุงุญูุงุช `butcher` ู `delivery`
3. ุชุฃูุฏ ูู ุฃู `is_banned = FALSE` ููููุธููู
